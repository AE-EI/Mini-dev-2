<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MiniDevis ‚Äî simple</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 12px; }
  .row { margin: 10px 0; }
  button { display:inline-block; margin:4px; padding:8px 12px; font-size:16px; }
  .grid { display:grid; grid-template-columns: repeat(6, 56px); gap:6px; margin-top:8px; }
  pre { background:#f6f6f6; padding:10px; white-space:pre-wrap; }
  .muted { color:#666; font-size:13px; }
</style>
<script>
// üîπ Anti-cache automatique : ajoute un param√®tre unique √† chaque ressource
(function() {
  const version = Date.now(); // timestamp = change √† chaque commit/push
  const links = document.querySelectorAll('link[rel="stylesheet"], script[src]');
  links.forEach(el => {
    const attr = el.tagName === 'SCRIPT' ? 'src' : 'href';
    if (el[attr] && !el[attr].includes('?v=')) {
      el[attr] += (el[attr].includes('?') ? '&' : '?') + 'v=' + version;
    }
  });
})();
</script>
</head>
<body>

<h2 id="title">Choisis une pi√®ce :</h2>
<div id="content"></div>
<div class="row">
  <button onclick="resetAll()">R√©initialiser</button>
  <button onclick="showSummary()">Voir le r√©sum√©</button>
</div>
<p class="muted">Version simple avec anti-cache automatique.</p>

<script>
/* ---------- Donn√©es & √©tat ---------- */
const PRIX = {
  "Prises - Encastree maconnerie": 120,
  "Prises - Apparent": 100,
  "Point lumineux - Encastree maconnerie": 80,
  "Point lumineux - Apparent": 70,
  "Interrupteur simple - Encastree maconnerie": 40,
  "Interrupteur simple - Apparent": 35,
  "Interrupteur double - Encastree maconnerie": 55,
  "Interrupteur double - Apparent": 50
};

const state = {
  devis: {},           
  notes: {},           
  currentRoom: null,   
  currentType: null,   
  currentPose: null    
};

/* ---------- Helpers DOM ---------- */
const $t = () => document.getElementById("title");
const $c = () => document.getElementById("content");

function btn(label, handler) {
  const b = document.createElement("button");
  b.textContent = label;
  b.onclick = handler;
  return b;
}

/* ---------- Flux principal ---------- */
function resetAll() {
  state.devis = {};
  state.notes = {};
  state.currentRoom = null;
  state.currentType = null;
  state.currentPose = null;
  showRooms();
}

function showRooms() {
  $t().textContent = "Choisis une pi√®ce :";
  $c().innerHTML = "";
  ["Cuisine","Chambre"].forEach(room => {
    const b = btn(room, () => {
      state.currentRoom = room;
      if (!state.devis[room]) state.devis[room] = [];
      showTypes();
    });
    $c().appendChild(b);
  });
}

function showTypes() {
  $t().textContent = `Que veux-tu ajouter dans ${state.currentRoom} ?`;
  $c().innerHTML = "";
  ["Prises","√âclairage","Sp√©cifique"].forEach(type => {
    const b = btn(type, () => {
      if (type === "Sp√©cifique") {
        addSpecific();
      } else {
        state.currentType = type;
        showPose();
      }
    });
    $c().appendChild(b);
  });
  $c().appendChild(btn("‚¨ÖÔ∏é Retour", showRooms));
}

function showPose() {
  $t().textContent = `Type de pose pour ${state.currentType} :`;
  $c().innerHTML = "";
  ["Encastree maconnerie","Apparent"].forEach(pose => {
    const b = btn(pose, () => { state.currentPose = pose; askQuantity(); });
    $c().appendChild(b);
  });
  $c().appendChild(btn("‚¨ÖÔ∏é Retour", showTypes));
}

function askQuantity() {
  $t().textContent = `Quantit√©s ‚Äî ${state.currentType} (${state.currentPose})`;
  $c().innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "grid";
  if (state.currentType === "Prises") {
    addQtyButtons(grid, "prises 2p+T", keyPrice("Prises"));
    $c().appendChild(grid);
    $c().appendChild(btn("Terminer cette ligne", showSummary));
    $c().appendChild(btn("‚¨ÖÔ∏é Retour", showPose));
    return;
  }
  askLightingSequence();
}

function askLightingSequence() {
  const steps = [
    { label: "Points lumineux", key: "Point lumineux" },
    { label: "Interrupteurs simples", key: "Interrupteur simple" },
    { label: "Interrupteurs doubles", key: "Interrupteur double" }
  ];
  let idx = 0;
  const next = () => {
    if (idx >= steps.length) {
      $c().appendChild(document.createElement("br"));
      $c().appendChild(btn("Terminer cette ligne", showSummary));
      $c().appendChild(btn("‚¨ÖÔ∏é Retour", showPose));
      return;
    }
    const step = steps[idx];
    $t().textContent = `${step.label} ‚Äî ${state.currentPose}`;
    $c().innerHTML = "";
    const grid = document.createElement("div");
    grid.className = "grid";
    addQtyButtons(grid, step.key.toLowerCase(), keyPrice(step.key), () => {
      idx++; next();
    });
    $c().appendChild(grid);
    $c().appendChild(btn("‚¨ÖÔ∏é Retour", showPose));
  };
  next();
}

/* ---------- Sp√©cifique ---------- */
function addSpecific() {
  const desc = prompt("Description de l'√©l√©ment sp√©cifique :");
  if (!desc) { showTypes(); return; }
  const prixStr = prompt("Prix estim√© (‚Ç¨/u) :");
  const qtyStr = prompt("Quantit√© : (laisser vide = 1)") || "1";
  const p = parseFloat((prixStr || "").replace(",", "."));
  const q = Math.max(1, parseInt(qtyStr, 10) || 1);
  const line = `- ${q} ${desc.trim()} (${isFinite(p) ? p : 0}‚Ç¨/u)`;
  state.devis[state.currentRoom].push(line);
  showSummary();
}

/* ---------- Utils ---------- */
function addQtyButtons(container, label, unitPrice, onPicked) {
  for (let i = 0; i <= 10; i++) {
    const b = document.createElement("button");
    b.textContent = i;
    b.onclick = () => {
      if (i > 0) {
        state.devis[state.currentRoom].push(
          `- ${i} ${pluralize(label, i)} - ${state.currentPose} (${unitPrice}‚Ç¨/u)`
        );
      }
      if (typeof onPicked === "function") onPicked();
    };
    container.appendChild(b);
  }
}

function keyPrice(kind) {
  return PRIX[`${kind} - ${state.currentPose}`] ?? 0;
}

function pluralize(base, n) {
  if (n > 1) {
    if (base.endsWith("lumineux")) return base;
    if (base.endsWith("simple")) return base.replace("simple", "simples");
    if (base.endsWith("double")) return base.replace("double", "doubles");
    return base + "s";
  }
  return base;
}

/* ---------- R√©sum√© / Notes / Texte ---------- */
function showSummary() {
  $t().textContent = "R√©sum√© du devis :";
  let html = "<pre>";
  const rooms = Object.keys(state.devis);
  if (rooms.length === 0) html += "(vide)\n";
  rooms.forEach((room, idx) => {
    if (idx) html += "\n";
    html += room + " :\n";
    const lines = state.devis[room];
    if (!lines.length) html += "  (aucune ligne)\n";
    lines.forEach(line => html += line + "\n");
    if (state.notes && state.notes[room]) {
      html += `  _${state.notes[room]}_\n`;
    }
  });
  html += "</pre>";
  html += '<div class="row">';
  html += '<button onclick="showRooms()">Ajouter autre chose</button>';
  html += '<button onclick="addOrEditNote()">Ajouter/modifier une note</button>';
  html += '<button onclick="showText()">Afficher en texte</button>';
  html += "</div>";
  $c().innerHTML = html;
}

function addOrEditNote() {
  const rooms = Object.keys(state.devis);
  if (rooms.length === 0) { alert("Aucune pi√®ce pour le moment."); return; }
  if (rooms.length === 1) return editNoteForRoom(rooms[0]);
  $t().textContent = "Choisir la pi√®ce pour la note :";
  $c().innerHTML = "";
  rooms.forEach(room => {
    $c().appendChild(btn(room, () => editNoteForRoom(room)));
  });
  $c().appendChild(btn("‚¨ÖÔ∏é Retour", showSummary));
}

function editNoteForRoom(room) {
  const existing = state.notes[room] ? `\n(Note actuelle : "${state.notes[room]}")` : "";
  const note = prompt(`Note pour "${room}" :` + existing, state.notes[room] || "");
  if (note !== null) {
    const trimmed = note.trim();
    if (trimmed) {
      state.notes[room] = trimmed;
    } else {
      delete state.notes[room];
    }
  }
  showSummary();
}

function showText() {
  let out = "";
  const rooms = Object.keys(state.devis);
  rooms.forEach((room, idx) => {
    if (idx) out += "\n";
    out += `**${room}**\n`;
    (state.devis[room] || []).forEach(line => { out += line + "\n"; });
    if (state.notes && state.notes[room]) {
      out += `_${state.notes[room]}_\n`;
    }
    out += "\n";
  });
  $t().textContent = "Texte √† copier :";
  $c().innerHTML = `<pre>${out || "(vide)"}</pre><div class="row"><button onclick="showSummary()">Retour</button></div>`;
}

/* ---------- Init ---------- */
showRooms();
</script>

</body>
</html>
