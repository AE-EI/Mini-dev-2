<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MiniDevis — simple</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 12px; }
  .row { margin: 10px 0; }
  button { display:inline-block; margin:4px; padding:8px 12px; font-size:16px; }
  .grid { display:grid; grid-template-columns: repeat(6, 56px); gap:6px; margin-top:8px; }
  pre { background:#f6f6f6; padding:10px; white-space:pre-wrap; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<h2 id="title">Choisis une pièce :</h2>
<div id="content"></div>
<div class="row">
  <button onclick="resetAll()">Réinitialiser</button>
  <button onclick="showSummary()">Voir le résumé</button>
</div>
<p class="muted">Version simple : 1 fichier, sans PWA — pour itérer vite.</p>

<script>
/* ---------- Données & état ---------- */
const PRIX = {
  "Prises - Encastree maconnerie": 120,
  "Prises - Apparent": 100,
  "Point lumineux - Encastree maconnerie": 80,
  "Point lumineux - Apparent": 70,
  "Interrupteur simple - Encastree maconnerie": 40,
  "Interrupteur simple - Apparent": 35,
  "Interrupteur double - Encastree maconnerie": 55,
  "Interrupteur double - Apparent": 50
};

const state = {
  devis: {},           // { "Cuisine": [ "- 2 prises ...", ... ], "Chambre": [...] }
  notes: {},           // { "Cuisine": "ma note", ... }
  currentRoom: null,   // "Cuisine" | "Chambre"
  currentType: null,   // "Prises" | "Éclairage"
  currentPose: null    // "Encastree maconnerie" | "Apparent"
};

/* ---------- Helpers DOM ---------- */
const $t = () => document.getElementById("title");
const $c = () => document.getElementById("content");

function btn(label, handler) {
  const b = document.createElement("button");
  b.textContent = label;
  b.onclick = handler;
  return b;
}

/* ---------- Flux principal ---------- */
function resetAll() {
  state.devis = {};
  state.notes = {};
  state.currentRoom = null;
  state.currentType = null;
  state.currentPose = null;
  showRooms();
}

function showRooms() {
  $t().textContent = "Choisis une pièce :";
  $c().innerHTML = "";
  ["Cuisine","Chambre"].forEach(room => {
    const b = btn(room, () => {
      state.currentRoom = room;
      if (!state.devis[room]) state.devis[room] = [];
      showTypes();
    });
    $c().appendChild(b);
  });
}

function showTypes() {
  $t().textContent = `Que veux-tu ajouter dans ${state.currentRoom} ?`;
  $c().innerHTML = "";
  // Prises, Éclairage, Spécifique
  ["Prises","Éclairage","Spécifique"].forEach(type => {
    const b = btn(type, () => {
      if (type === "Spécifique") {
        addSpecific();
      } else {
        state.currentType = type;
        showPose();
      }
    });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showRooms));
}

function showPose() {
  $t().textContent = `Type de pose pour ${state.currentType} :`;
  $c().innerHTML = "";
  ["Encastree maconnerie","Apparent"].forEach(pose => {
    const b = btn(pose, () => { state.currentPose = pose; askQuantity(); });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showTypes));
}

function askQuantity() {
  $t().textContent = `Quantités — ${state.currentType} (${state.currentPose})`;
  $c().innerHTML = "";

  // grille 0..10
  const grid = document.createElement("div");
  grid.className = "grid";

  if (state.currentType === "Prises") {
    addQtyButtons(grid, "prises 2p+T", keyPrice("Prises"));
    $c().appendChild(grid);
    $c().appendChild(btn("Terminer cette ligne", showSummary));
    $c().appendChild(btn("⬅︎ Retour", showPose));
    return;
  }

  // Éclairage: on demande successivement points / inter simple / inter double
  askLightingSequence();
}

function askLightingSequence() {
  const steps = [
    { label: "Points lumineux", key: "Point lumineux" },
    { label: "Interrupteurs simples", key: "Interrupteur simple" },
    { label: "Interrupteurs doubles", key: "Interrupteur double" }
  ];
  let idx = 0;

  const next = () => {
    if (idx >= steps.length) {
      $c().appendChild(document.createElement("br"));
      $c().appendChild(btn("Terminer cette ligne", showSummary));
      $c().appendChild(btn("⬅︎ Retour", showPose));
      return;
    }
    const step = steps[idx];
    $t().textContent = `${step.label} — ${state.currentPose}`;
    $c().innerHTML = "";
    const grid = document.createElement("div");
    grid.className = "grid";
    addQtyButtons(grid, step.key.toLowerCase(), keyPrice(step.key), () => {
      idx++; next();
    });
    $c().appendChild(grid);
    $c().appendChild(btn("⬅︎ Retour", showPose));
  };

  next();
}

/* ---------- Spécifique (saisie libre + prix + qty) ---------- */
function addSpecific() {
  const desc = prompt("Description de l'élément spécifique :");
  if (!desc) { showTypes(); return; }
  const prixStr = prompt("Prix estimé (€/u) :");
  const qtyStr = prompt("Quantité : (laisser vide = 1)") || "1";

  const p = parseFloat((prixStr || "").toString().replace(",", "."));
  const q = Math.max(1, parseInt(qtyStr, 10) || 1);

  const line = `- ${q} ${desc.trim()} (${isFinite(p) ? p : 0}€/u)`;
  state.devis[state.currentRoom].push(line);
  showSummary();
}

/* ---------- Utilitaires de quantités ---------- */
function addQtyButtons(container, label, unitPrice, onPicked) {
  for (let i = 0; i <= 10; i++) {
    const b = document.createElement("button");
    b.textContent = i;
    b.onclick = () => {
      if (i > 0) {
        state.devis[state.currentRoom].push(
          `- ${i} ${pluralize(label, i)} - ${state.currentPose} (${unitPrice}€/u)`
        );
      }
      if (typeof onPicked === "function") onPicked();
    };
    container.appendChild(b);
  }
}

function keyPrice(kind) {
  // kind: "Prises" | "Point lumineux" | "Interrupteur simple" | "Interrupteur double"
  return PRIX[`${kind} - ${state.currentPose}`] ?? 0;
}

function pluralize(base, n) {
  if (n > 1) {
    if (base.endsWith("lumineux")) return base; // invariable ici
    if (base.endsWith("simple")) return base.replace("simple", "simples");
    if (base.endsWith("double")) return base.replace("double", "doubles");
    return base + "s";
  }
  return base;
}

/* ---------- Résumé / Notes / Texte ---------- */
function showSummary() {
  $t().textContent = "Résumé du devis :";
  let html = "<pre>";
  const rooms = Object.keys(state.devis);
  if (rooms.length === 0) html += "(vide)\n";
  rooms.forEach((room, idx) => {
    if (idx) html += "\n";
    html += room + " :\n";
    const lines = state.devis[room];
    if (!lines.length) html += "  (aucune ligne)\n";
    lines.forEach(line => html += line + "\n");
    if (state.notes && state.notes[room]) {
      html += `  _${state.notes[room]}_\n`; // note en italique en fin de pièce
    }
  });
  html += "</pre>";

  // actions
  html += '<div class="row">';
  html += '<button onclick="showRooms()">Ajouter autre chose</button>';
  html += '<button onclick="addOrEditNote()">Ajouter/modifier une note</button>';
  html += '<button onclick="showText()">Afficher en texte</button>';
  html += "</div>";

  $c().innerHTML = html;
}

function addOrEditNote() {
  // Choix de la pièce si plusieurs
  const rooms = Object.keys(state.devis);
  if (rooms.length === 0) { alert("Aucune pièce pour le moment."); return; }

  // S'il n'y en a qu'une, on édite directement
  if (rooms.length === 1) return editNoteForRoom(rooms[0]);

  // Sinon, on propose de choisir
  $t().textContent = "Choisir la pièce pour la note :";
  $c().innerHTML = "";
  rooms.forEach(room => {
    $c().appendChild(btn(room, () => editNoteForRoom(room)));
  });
  $c().appendChild(btn("⬅︎ Retour", showSummary));
}

function editNoteForRoom(room) {
  const existing = (state.notes && state.notes[room]) ? `\n(Note actuelle : "${state.notes[room]}")` : "";
  const note = prompt("Note pour la pièce \"" + room + "\" :" + existing, state.notes[room] || "");
  if (note !== null) {
    const trimmed = note.trim();
    if (trimmed) {
      state.notes[room] = trimmed; // unique par pièce
    } else {
      delete state.notes[room]; // supprimer si vide
    }
  }
  showSummary();
}

function showText() {
  // Affichage "texte" : pièce en gras (markdown **), espace entre chaque pièce
  let out = "";
  const rooms = Object.keys(state.devis);
  rooms.forEach((room, idx) => {
    if (idx) out += "\n";
    out += `**${room}**\n`; // pièce en gras
    (state.devis[room] || []).forEach(line => { out += line + "\n"; });
    if (state.notes && state.notes[room]) {
      out += `_${state.notes[room]}_\n`; // note en italique
    }
    out += "\n"; // espace entre pièces
  });
  $t().textContent = "Texte à copier :";
  $c().innerHTML = `<pre>${out || "(vide)"}</pre><div class="row"><button onclick="showSummary()">Retour</button></div>`;
}

/* ---------- Démarrage ---------- */
showRooms();
</script>

</body>
</html>
