<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniDevis</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  h1, h2 { text-align: center; }
  button { padding: 10px; margin: 5px; font-size: 16px; cursor: pointer; }
  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .back-btn { background: #ccc; }
  .copy-btn { background: #4CAF50; color: white; }
  pre { background: white; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>MiniDevis</h1>
<div id="app"></div>

<script>
// ================= PRIX CONFIGURABLES =================
const prix = {
  'prise_creation_encastre': 120,
  'prise_creation_placo': 120,
  'prise_creation_semi': 120,
  'prise_creation_surmesure': 120,
  'prise_recablage_sans_remplacement': 50,
  'prise_recablage_avec_remplacement': 70, // 50 + 20
  'prise_remplacement': 20,
  'interrupteur_simple': 40,
  'interrupteur_double': 60,
  'point_lumineux': 80,
  'specifique': 0
};
// ======================================================

let devis = {};

function showPieces() {
  const pieces = [
    "Cuisine", "Chambre", "Salle de bain", "Salle d'eau", "Garage", "Couloir",
    "Débarras", "Salon", "Salle à manger", "Extérieur", "Grenier/combles"
  ];
  let html = "<h2>Choisissez une pièce</h2><div class='grid'>";
  pieces.forEach(p => {
    html += `<button onclick="selectPiece('${p}')">${p}</button>`;
  });
  html += "</div><button onclick='showResume()'>Voir Résumé</button>";
  document.getElementById("app").innerHTML = html;
}

function selectPiece(piece) {
  devis[piece] = devis[piece] || { elements: [], note: "" };
  let html = `<button class='back-btn' onclick="showPieces()">⬅ Retour</button>`;
  html += `<h2>${piece}</h2>`;
  html += `<div class='grid'>
    <button onclick="selectElement('${piece}','prises')">Prises</button>
    <button onclick="selectElement('${piece}','eclairage')">Éclairage</button>
    <button onclick="selectElement('${piece}','specifique')">Spécifique</button>
  </div>`;
  html += `<button onclick="addNote('${piece}')">Ajouter/Modifier Note</button>`;
  document.getElementById("app").innerHTML = html;
}

function selectElement(piece, type) {
  if (type === 'prises') {
    showPrisesType(piece);
  } else if (type === 'eclairage') {
    showEclairageType(piece);
  } else if (type === 'specifique') {
    showSpecifique(piece);
  }
}

// ===== PRISES FLOW =====
function showPrisesType(piece) {
  let html = `<button class='back-btn' onclick="selectPiece('${piece}')">⬅ Retour</button>`;
  html += `<h2>Type d'intervention</h2><div class='grid'>
    <button onclick="priseCreation('${piece}')">Création</button>
    <button onclick="priseRecablage('${piece}')">Recâblage</button>
    <button onclick="priseRemplacement('${piece}')">Remplacement</button>
  </div>`;
  document.getElementById("app").innerHTML = html;
}

function priseCreation(piece) {
  showPose(piece, 'prise_creation');
}

function priseRecablage(piece) {
  let html = `<button class='back-btn' onclick="showPrisesType('${piece}')">⬅ Retour</button>`;
  html += `<h2>Recâblage</h2><div class='grid'>
    <button onclick="qtyGrid('${piece}','Prise recâblage sans remplacement',prix.prise_recablage_sans_remplacement)">Sans remplacement</button>
    <button onclick="qtyGrid('${piece}','Prise recâblage avec remplacement',prix.prise_recablage_avec_remplacement)">Avec remplacement</button>
  </div>`;
  document.getElementById("app").innerHTML = html;
}

function priseRemplacement(piece) {
  qtyGrid(piece, 'Remplacement appareillage', prix.prise_remplacement);
}

// ===== ÉCLAIRAGE FLOW =====
function showEclairageType(piece) {
  let html = `<button class='back-btn' onclick="selectPiece('${piece}')">⬅ Retour</button>`;
  html += `<h2>Type d'éclairage</h2><div class='grid'>
    <button onclick="showPose('${piece}','point_lumineux')">Point lumineux</button>
    <button onclick="showPose('${piece}','interrupteur_simple')">Interrupteur simple</button>
    <button onclick="showPose('${piece}','interrupteur_double')">Interrupteur double</button>
  </div>`;
  document.getElementById("app").innerHTML = html;
}

// ===== SPÉCIFIQUE =====
function showSpecifique(piece) {
  let html = `<button class='back-btn' onclick="selectPiece('${piece}')">⬅ Retour</button>`;
  html += `<h2>Élément spécifique</h2>
    <input id="specName" placeholder="Nom" style="width:100%;margin-bottom:10px;">
    <input id="specPrice" type="number" placeholder="Prix €" style="width:100%;margin-bottom:10px;">
    <button onclick="qtyGrid('${piece}',document.getElementById('specName').value,parseFloat(document.getElementById('specPrice').value||0))">Suivant</button>`;
  document.getElementById("app").innerHTML = html;
}

// ===== TYPE DE POSE =====
function showPose(piece, baseKey) {
  const poses = [
    {name:"Encastré maçonnerie", key:"_encastre"},
    {name:"Placo", key:"_placo"},
    {name:"Semi-encastré", key:"_semi"},
    {name:"Sur-mesure", key:"_surmesure"}
  ];
  let html = `<button class='back-btn' onclick="selectPiece('${piece}')">⬅ Retour</button>`;
  html += `<h2>Type de pose</h2><div class='grid'>`;
  poses.forEach(p => {
    let fullKey = baseKey + p.key;
    html += `<button onclick="qtyGrid('${piece}','${p.name}',prix['${fullKey}'])">${p.name}</button>`;
  });
  html += "</div>";
  document.getElementById("app").innerHTML = html;
}

// ===== QUANTITÉS =====
function qtyGrid(piece, label, unitPrice) {
  let html = `<button class='back-btn' onclick="selectPiece('${piece}')">⬅ Retour</button>`;
  html += `<h2>${label}</h2><div class='grid'>`;
  for (let i = 1; i <= 10; i++) {
    html += `<button onclick="addItem('${piece}','${label}',${unitPrice},${i})">${i}</button>`;
  }
  html += "</div>";
  document.getElementById("app").innerHTML = html;
}

function addItem(piece, label, price, qty) {
  devis[piece].elements.push({ label, price, qty });
  selectPiece(piece);
}

// ===== NOTES =====
function addNote(piece) {
  let current = devis[piece].note || "";
  let note = prompt("Note pour " + piece, current);
  if (note !== null) devis[piece].note = note;
  selectPiece(piece);
}

// ===== RÉSUMÉ =====
function showResume() {
  let html = `<button class='back-btn' onclick="showPieces()">⬅ Retour</button>`;
  html += `<h2>Résumé</h2><pre id="resumeText">${getResumeText()}</pre>`;
  html += `<button class='copy-btn' onclick="copyText()">Copier le texte</button>`;
  html += `<button onclick="downloadTxt()">Télécharger .txt</button>`;
  document.getElementById("app").innerHTML = html;
}

function getResumeText() {
  let text = "";
  for (let piece in devis) {
    text += `**${piece}**\n`;
    devis[piece].elements.forEach(el => {
      text += `-${el.qty} ${el.label} (${el.price}€/u)\n`;
    });
    if (devis[piece].note) text += `*${devis[piece].note}*\n`;
    text += "\n";
  }
  return text.trim();
}

function copyText() {
  navigator.clipboard.writeText(getResumeText()).then(() => {
    alert("Résumé copié !");
  });
}

function downloadTxt() {
  const blob = new Blob([getResumeText()], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "devis.txt";
  a.click();
}

showPieces();
</script>
</body>
</html>
