<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MiniDevis — version simple</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 12px; }
  .row { margin: 10px 0; }
  button { display:inline-block; margin:4px; padding:8px 12px; font-size:16px; background:#eee; border:1px solid #ccc; cursor:pointer; }
  .grid { display:grid; grid-template-columns: repeat(6, 56px); gap:6px; margin-top:8px; }
  pre { background:#f6f6f6; padding:10px; white-space:pre-wrap; }
  .muted { color:#666; font-size:13px; }
</style>
<script>
// Anti-cache automatique
(function() {
  const version = Date.now();
  const links = document.querySelectorAll('link[rel="stylesheet"], script[src]');
  links.forEach(el => {
    const attr = el.tagName === 'SCRIPT' ? 'src' : 'href';
    if (el[attr] && !el[attr].includes('?v=')) {
      el[attr] += (el[attr].includes('?') ? '&' : '?') + 'v=' + version;
    }
  });
})();
</script>
</head>
<body>

<h2 id="title">Choisis une pièce :</h2>
<div id="content"></div>
<div class="row">
  <button onclick="resetAll()">Réinitialiser</button>
  <button onclick="showSummary()">Voir le résumé</button>
</div>
<p class="muted">Version simple avec anti-cache automatique.</p>

<script>
/* ---------- Données ---------- */
const PRIX = {
  "Prises - Encastree maconnerie": 120,
  "Prises - Apparent": 100,
  "Point lumineux - Encastree maconnerie": 80,
  "Point lumineux - Apparent": 70,
  "Interrupteur simple - Encastree maconnerie": 40,
  "Interrupteur simple - Apparent": 35,
  "Interrupteur double - Encastree maconnerie": 55,
  "Interrupteur double - Apparent": 50
};

const state = {
  devis: {},
  notes: {},
  currentRoom: null,
  currentType: null,
  currentPose: null
};

/* ---------- Helpers DOM ---------- */
const $t = () => document.getElementById("title");
const $c = () => document.getElementById("content");
function btn(label, handler) { const b = document.createElement("button"); b.textContent = label; b.onclick = handler; return b; }

/* ---------- Navigation ---------- */
function resetAll() {
  state.devis = {};
  state.notes = {};
  state.currentRoom = null;
  showRooms();
}

function showRooms() {
  $t().textContent = "Choisis une pièce :";
  $c().innerHTML = "";
  ["Cuisine","Chambre"].forEach(room => {
    const b = btn(room, () => {
      state.currentRoom = room;
      if (!state.devis[room]) state.devis[room] = [];
      showTypes();
    });
    $c().appendChild(b);
  });
}

function showTypes() {
  $t().textContent = `Que veux-tu ajouter dans ${state.currentRoom} ?`;
  $c().innerHTML = "";
  ["Prises","Éclairage","Spécifique"].forEach(type => {
    const b = btn(type, () => {
      if (type === "Spécifique") addSpecific();
      else { state.currentType = type; showPose(); }
    });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showRooms));
}

function showPose() {
  $t().textContent = `Type de pose pour ${state.currentType} :`;
  $c().innerHTML = "";
  ["Encastree maconnerie","Apparent"].forEach(pose => {
    const b = btn(pose, () => { state.currentPose = pose; askQuantity(); });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showTypes));
}

function askQuantity() {
  if (state.currentType === "Prises") {
    qtyGrid("prises 2p+T", keyPrice("Prises"), showSummary);
    return;
  }
  askLighting();
}

function askLighting() {
  const steps = [
    { label: "Points lumineux", key: "Point lumineux" },
    { label: "Interrupteurs simples", key: "Interrupteur simple" },
    { label: "Interrupteurs doubles", key: "Interrupteur double" }
  ];
  let i = 0;
  const next = () => { if (i >= steps.length) { showSummary(); return; }
    const s = steps[i];
    qtyGrid(s.key.toLowerCase(), keyPrice(s.key), () => { i++; next(); });
  };
  next();
}

/* ---------- Spécifique ---------- */
function addSpecific() {
  const desc = prompt("Description de l'élément spécifique :");
  if (!desc) return showTypes();
  const prix = prompt("Prix estimé (€/u) :") || "0";
  const qty = prompt("Quantité :") || "1";
  state.devis[state.currentRoom].push(`- ${qty} ${desc} (${prix}€/u)`);
  showSummary();
}

/* ---------- Utilitaires ---------- */
function qtyGrid(label, unitPrice, cb) {
  $t().textContent = `Quantité — ${label}`;
  $c().innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "grid";
  for (let i = 0; i <= 10; i++) {
    const b = document.createElement("button");
    b.textContent = i;
    b.onclick = () => {
      if (i > 0) state.devis[state.currentRoom].push(`- ${i} ${label} - ${state.currentPose} (${unitPrice}€/u)`);
      cb();
    };
    grid.appendChild(b);
  }
  $c().appendChild(grid);
}

function keyPrice(kind) {
  return PRIX[`${kind} - ${state.currentPose}`] ?? 0;
}

/* ---------- Résumé / Notes / Texte ---------- */
function showSummary() {
  $t().textContent = "Résumé du devis :";
  let html = "<pre>";
  const rooms = Object.keys(state.devis);
  if (!rooms.length) html += "(vide)\n";
  rooms.forEach((room, idx) => {
    if (idx) html += "\n";
    html += room + " :\n";
    (state.devis[room] || []).forEach(line => html += line + "\n");
    if (state.notes[room]) html += `_${state.notes[room]}_\n`;
  });
  html += "</pre>";
  html += '<div class="row">';
  html += '<button onclick="showRooms()">Ajouter autre chose</button>';
  html += '<button onclick="addNote()">Ajouter/modifier une note</button>';
  html += '<button onclick="showText()">Afficher en texte</button>';
  html += "</div>";
  $c().innerHTML = html;
}

function addNote() {
  const note = prompt(`Note pour ${state.currentRoom} :`, state.notes[state.currentRoom] || "");
  if (note !== null) state.notes[state.currentRoom] = note.trim();
  showSummary();
}

function showText() {
  let out = "";
  const rooms = Object.keys(state.devis);
  rooms.forEach((room, idx) => {
    if (idx) out += "\n";
    out += `<strong>${room}</strong>\n`;
    (state.devis[room] || []).forEach(line => out += line + "\n");
    if (state.notes[room]) out += `_${state.notes[room]}_\n`;
    out += "\n";
  });
  $t().textContent = "Texte à copier :";
  $c().innerHTML = `<pre>${out || "(vide)"}</pre><div class="row"><button onclick="showSummary()">Retour</button></div>`;
}

/* ---------- Init ---------- */
showRooms();
</script>

</body>
</html>
