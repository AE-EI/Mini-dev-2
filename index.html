<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MiniDevis</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  h2 { margin: 0 0 12px; }
  button { margin:4px; padding:8px 12px; font-size:16px; background:#eee; border:1px solid #ccc; cursor:pointer; }
  .grid { display:grid; grid-template-columns: repeat(6, 56px); gap:6px; margin-top:8px; }
  .pieces-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
  pre { background:#f6f6f6; padding:10px; white-space:pre-wrap; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<h2 id="title">Choisis une pièce :</h2>
<div id="content"></div>
<div>
  <button onclick="resetAll()">Réinitialiser</button>
  <button onclick="showSummary()">Voir le résumé</button>
</div>
<p class="muted">Version simple — ajoutez ?v=xxx à l’URL pour forcer la mise à jour.</p>

<script>
const PRIX = {
  "Prises - Encastré maçonnerie": 120,
  "Prises - Placo": 0,
  "Prises - Semi-encastré": 0,
  "Prises - Sur-mesure": 0,
  "Point lumineux - Encastré maçonnerie": 80,
  "Point lumineux - Placo": 0,
  "Point lumineux - Semi-encastré": 0,
  "Point lumineux - Sur-mesure": 0,
  "Interrupteur simple - Encastré maçonnerie": 40,
  "Interrupteur simple - Placo": 0,
  "Interrupteur simple - Semi-encastré": 0,
  "Interrupteur simple - Sur-mesure": 0,
  "Interrupteur double - Encastré maçonnerie": 55,
  "Interrupteur double - Placo": 0,
  "Interrupteur double - Semi-encastré": 0,
  "Interrupteur double - Sur-mesure": 0
};

const state = { devis: {}, notes: {}, currentRoom: null, currentType: null, currentPose: null };
const $t = () => document.getElementById("title");
const $c = () => document.getElementById("content");
function btn(label, handler) { const b = document.createElement("button"); b.textContent = label; b.onclick = handler; return b; }

function resetAll() {
  state.devis = {}; state.notes = {}; state.currentRoom = null; showRooms();
}

function showRooms() {
  $t().textContent = "Choisis une pièce :";
  $c().innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "pieces-grid";
  [
    "Cuisine","Chambre","Salle de bain","Salle d’eau","Garage",
    "Couloir","Débarras","Salon","Salle à manger","Extérieur","Grenier/combles"
  ].forEach(room => {
    const b = btn(room, () => {
      state.currentRoom = room;
      if (!state.devis[room]) state.devis[room] = [];
      showTypes();
    });
    grid.appendChild(b);
  });
  $c().appendChild(grid);
}

function showTypes() {
  $t().textContent = `Que veux-tu ajouter dans ${state.currentRoom} ?`;
  $c().innerHTML = "";
  ["Prises","Éclairage","Spécifique"].forEach(type => {
    const b = btn(type, () => {
      if (type === "Spécifique") addSpecific();
      else { state.currentType = type; showPose(); }
    });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showRooms));
}

function showPose() {
  $t().textContent = `Type de pose pour ${state.currentType} :`;
  $c().innerHTML = "";
  ["Encastré maçonnerie","Placo","Semi-encastré","Sur-mesure"].forEach(pose => {
    const b = btn(pose, () => { state.currentPose = pose; askQuantity(); });
    $c().appendChild(b);
  });
  $c().appendChild(btn("⬅︎ Retour", showTypes));
}

function askQuantity() {
  if (state.currentType === "Prises") {
    qtyGrid("prises 2p+T", keyPrice("Prises"), showSummary);
    return;
  }
  askLighting();
}

function askLighting() {
  const steps = [
    { label: "Points lumineux", key: "Point lumineux" },
    { label: "Interrupteurs simples", key: "Interrupteur simple" },
    { label: "Interrupteurs doubles", key: "Interrupteur double" }
  ];
  let i = 0;
  const next = () => { if (i >= steps.length) { showSummary(); return; }
    const s = steps[i];
    qtyGrid(s.key.toLowerCase(), keyPrice(s.key), () => { i++; next(); });
  };
  next();
}

function addSpecific() {
  const desc = prompt("Description de l'élément spécifique :");
  if (!desc) return showTypes();
  const prix = prompt("Prix estimé (€/u) :") || "0";
  const qty = prompt("Quantité :") || "1";
  state.devis[state.currentRoom].push(`- ${qty} ${desc} (${prix}€/u)`);
  showSummary();
}

function qtyGrid(label, unitPrice, cb) {
  $t().textContent = `Quantité — ${label}`;
  $c().innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "grid";
  for (let i = 0; i <= 10; i++) {
    const b = document.createElement("button");
    b.textContent = i;
    b.onclick = () => {
      if (i > 0) state.devis[state.currentRoom].push(`- ${i} ${label} - ${state.currentPose} (${unitPrice}€/u)`);
      cb();
    };
    grid.appendChild(b);
  }
  $c().appendChild(grid);
}

function keyPrice(kind) { return PRIX[`${kind} - ${state.currentPose}`] ?? 0; }

function showSummary() {
  $t().textContent = "Résumé du devis :";
  let html = "<pre>";
  const rooms = Object.keys(state.devis);
  if (!rooms.length) html += "(vide)\n";
  rooms.forEach((room, idx) => {
    if (idx) html += "\n";
    html += `${room} :\n`;
    (state.devis[room] || []).forEach(line => html += line + "\n");
    if (state.notes[room]) html += `_${state.notes[room]}_\n`;
  });
  html += "</pre>";
  html += '<div>';
  html += '<button onclick="showRooms()">Ajouter autre chose</button>';
  html += '<button onclick="addNote()">Ajouter/modifier une note</button>';
  html += '<button onclick="showText()">Afficher en texte</button>';
  html += "</div>";
  $c().innerHTML = html;
}

function addNote() {
  const note = prompt(`Note pour ${state.currentRoom} :`, state.notes[state.currentRoom] || "");
  if (note !== null) state.notes[state.currentRoom] = note.trim();
  showSummary();
}

function showText() {
  let out = "";
  const rooms = Object.keys(state.devis);
  rooms.forEach((room, idx) => {
    if (idx) out += "\n";
    out += `**${room}**\n`;
    (state.devis[room] || []).forEach(line => out += line + "\n");
    if (state.notes[room]) out += `_${state.notes[room]}_\n`;
    out += "\n";
  });
  $t().textContent = "Texte à copier :";
  $c().innerHTML = `<pre>${out || "(vide)"}</pre><div><button onclick="showSummary()">Retour</button></div>`;
}

showRooms();
</script>
</body>
</html>
