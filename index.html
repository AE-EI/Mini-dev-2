<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MiniDevis — Mode test</title>
<style>
  :root { --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666; --line:#e8e8e8; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
  header { position:sticky; top:0; z-index:10; background:#111; color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
  main { max-width: 980px; margin: 0 auto; padding: 16px; }
  h2 { margin: 8px 0 12px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .grid-2 { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; }
  .grid-qty { display:grid; grid-template-columns: repeat(6,56px); gap:8px; }
  .btn { padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; border-color:#000; }
  .btn.back { background:#ddd; }
  .btn.ghost { background:#fff; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; }
  .muted { color:var(--muted); }
  pre { white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
  .kpi { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:var(--card); margin-bottom:8px; }
  .kpi .val { font-variant-numeric: tabular-nums; font-weight:700; }
  input[type="text"], input[type="number"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:16px; }
  .hidden { display:none; }
</style>
</head>
<body>
<header id="banner">MiniDevis — Mode test — 12/08/2025</header>
<main id="app"></main>

<script>
/* ===========================
   PARTIE 1 — BASE & HELPERS
   =========================== */

/* Code d’accès conservé mais DÉSACTIVÉ (REQUIRE_CODE=false) */
const ACCESS_CODE = "AE-0825";
const REQUIRE_CODE = false;

/* Pièces et sections */
const PIECES = [
  "Cuisine","Chambre","Salle de bain","Salle d’eau","Garage",
  "Couloir","Débarras","Salon","Salle à manger","Extérieur","Grenier/combles"
];

/* Poses disponibles pour les créations */
const POSES = ["Encastré maçonnerie","Placo","Semi-encastré","Sur-mesure"];

/* Catégories et désignations (côté pièces) */
const DESIGNATIONS_PAR_CATEGORIE = {
  "Prises": ["Prise"],
  "Éclairage": ["Point de centre","Applique","Interrupteur simple","Interrupteur double"]
};

/* Tarifs centralisés (par défaut validés ensemble) */
const TARIFS = {
  "Prise": { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  "Point de centre": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 }, // remplacement = luminaire
  "Applique": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },       // remplacement = luminaire
  "Interrupteur simple": { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  "Interrupteur double": { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 }
};

/* Installations spécifiques — barème par défaut */
const IS_TERRA = {
  complete_base: 500,
  piquet_supp: 100, // +2m câblette inclus
  part_conducteur_m: 20,
  part_barrette: 40,
  part_piquet_pack: 120
};
const IS_VENTIL = {
  bouche_remplacement: 40,
  bouche_creation: 120,
  groupe_remplacement: 200,
  pack_creation: 900,
  bouche_supp: 120,
  gaine_m: 10,
  chapeau_125: 180,
  alim_groupe: 100,
  nettoyage: 80
};
const IS_TABLEAU = {
  circ_prises: 180,
  circ_eclairage: 150,
  circ_specialise: 200,
  recablage_circuit: 100,
  remplacement_protection: 40,
  remplacement_tableau: 800,
  tableau_secondaire: 500,
  extension_tableau: 250
};

/* État global */
let devis = {}; // { sectionLabel: { items:[{...}], note:"" } }
let ctx = { piece:null, category:null, intervention:null, pose:null, designation:null };

/* Rendu */
const $app = () => document.getElementById('app');
function view(html){ $app().innerHTML = html; }
function b(label, action, cls="btn"){ return `<button class="${cls}" onclick="${action}">${label}</button>`; }

/* Utilitaires */
function euro(n){ return `${(+n).toFixed(2)} €`; }
function sum(a){ return a.reduce((s,x)=>s+x,0); }

/* Navigation de base */
function pageHome(){
  // Section pièces
  const btnPieces = PIECES.map(p=> b(p, `goPiece('${p}')`) ).join('');
  // Section Installations spécifiques
  const isHtml = `
    ${b("Mise à la terre","pageISTerre()")}
    ${b("Ventilation","pageISVentil()")}
    ${b("Distribution tableau","pageISTableau()")}
  `;
  view(`
    <div class="card">
      <h2>Choisir une pièce</h2>
      <div class="grid-2">${btnPieces}</div>
      <div class="row" style="margin-top:12px;">
        ${b("Voir totaux","pageTotals()")}
        ${b("Voir l’estimatif","pageResume()")}
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h2>Installations spécifiques</h2>
      <div class="row">${isHtml}</div>
    </div>
    <p class="muted" style="margin-top:8px;">Astuce : ajoute <b>?v=build1</b> à l’URL après mise à jour pour forcer l’actualisation.</p>
  `);
}

/* Initialisation (code d’accès désactivé) */
function init(){
  if(REQUIRE_CODE){
    view(`
      <div class="card">
        <h2>Code d’accès</h2>
        <input id="code" type="password" placeholder="Code">
        <div class="row" style="margin-top:8px;">
          ${b("Valider","checkCode()","btn primary")}
        </div>
        <p id="code_err" class="muted"></p>
      </div>
    `);
  } else {
    pageHome();
  }
}
function checkCode(){
  const v = (document.getElementById('code').value||"").trim();
  if(v===ACCESS_CODE) pageHome(); else {
    document.getElementById('code_err').textContent = "Code incorrect.";
  }
}

/* Lance l’app */
init();
</script>
</body>
</html>
/* ===========================
   PARTIE 2 — LOGIQUE PIÈCES
   =========================== */

/* Sélection d'une pièce */
function goPiece(piece){
  ctx.piece = piece;
  const cats = Object.keys(DESIGNATIONS_PAR_CATEGORIE)
    .map(cat => b(cat, `goCategory('${cat}')`))
    .join('') + b("Spécifique",`pageSpecifique()`,"btn ghost");
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>${piece}</h2>
      <div class="row">${cats}</div>
    </div>
  `);
}

/* Sélection de catégorie (Prises / Éclairage) */
function goCategory(cat){
  ctx.category = cat;
  const interv = cat==="Prises"
    ? ["Création","Remplacement appareillage","Recâblage sans remplacement appareillage","Recâblage avec remplacement appareillage"]
    : ["Création","Remplacement luminaire","Recâblage sans remplacement appareillage","Recâblage avec remplacement appareillage"];
  const buttons = interv.map(i=> b(i,`goIntervention('${i}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goPiece('${ctx.piece}')`,"btn back")}
      <h2>${ctx.category}</h2>
      <div class="row">${buttons}</div>
    </div>
  `);
}

/* Intervention choisie */
function goIntervention(interv){
  ctx.intervention = interv;
  // Pose uniquement si création
  if(interv==="Création"){
    const poses = POSES.map(p=> b(p,`goDesignation('${p}')`)).join('');
    view(`
      <div class="card">
        ${b("Retour",`goCategory('${ctx.category}')`,"btn back")}
        <h2>Type de pose</h2>
        <div class="row">${poses}</div>
      </div>
    `);
  } else {
    goDesignation(null);
  }
}

/* Désignation (prise, point de centre...) */
function goDesignation(pose){
  ctx.pose = pose;
  const designations = DESIGNATIONS_PAR_CATEGORIE[ctx.category];
  const buttons = designations.map(d=> b(d,`pageQuantite('${d}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour", ctx.intervention==="Création"
        ? `goIntervention('${ctx.intervention}')`
        : `goCategory('${ctx.category}')`,"btn back")}
      <h2>Désignation</h2>
      <div class="row">${buttons}</div>
    </div>
  `);
}

/* Quantité */
function pageQuantite(designation){
  ctx.designation = designation;
  const qtyBtns = Array.from({length:10},(_,i)=> b(i+1,`saveItem(${i+1})`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goDesignation('${ctx.pose}')`,"btn back")}
      <h2>Quantité</h2>
      <div class="grid-qty">${qtyBtns}</div>
    </div>
  `);
}

/* Sauvegarde dans l'état global */
function saveItem(qty){
  const sec = ctx.piece;
  if(!devis[sec]) devis[sec] = { items:[], note:"" };
  devis[sec].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: ctx.pose,
    designation: ctx.designation,
    qty: qty,
    prixU: getPrix(ctx.designation, ctx.intervention)
  });
  pageHome();
}

/* Calcul du prix unitaire */
function getPrix(designation, intervention){
  const base = TARIFS[designation] || {};
  if(intervention.includes("Création")) return base.creation||0;
  if(intervention.includes("sans remplacement")) return base.recablage_sans||0;
  if(intervention.includes("avec remplacement")) return base.recablage_avec||0;
  if(intervention.includes("Remplacement")) return base.remplacement||0;
  return 0;
}

/* Spécifique dans une pièce */
function pageSpecifique(){
  const label = prompt("Nom de la prestation spécifique :","");
  if(!label) return goPiece(ctx.piece);
  const prix = parseFloat(prompt("Prix estimé (€) :","0"))||0;
  const sec = ctx.piece;
  if(!devis[sec]) devis[sec] = { items:[], note:"" };
  devis[sec].items.push({
    category: "Spécifique",
    intervention: "",
    pose: "",
    designation: label,
    qty: 1,
    prixU: prix
  });
  pageHome();
}
/* ================================
   PARTIE 3 — INSTALL. SPÉCIFIQUES
   ================================ */

/* Helper: ajout d’un poste “installation spécifique” */
function addIS(section, label, prixU, qty=1, unit="u"){
  if(!devis[section]) devis[section] = { items:[], note:"" };
  devis[section].items.push({
    category: "Installation spécifique",
    intervention: "",
    pose: "",
    designation: label,
    qty: qty,
    prixU: +prixU,
    unit: unit
  });
  alert(`${label} ajouté (${qty} ${unit}, ${prixU}€/ ${unit})`);
  pageHome();
}

/* Helper: grille quantité 1..10 appelant une callback(qty) */
function qtyGrid(title, cb){
  const btns = Array.from({length:10},(_,i)=> b(i+1,`(${cb.toString()} )(${i+1})`)).join('');
  // NOTE: on ne peut pas sérialiser cb directement, donc on génère une “factory” dédiée ci-dessous
}

/* ===== MISE À LA TERRE ===== */
function pageISTerre(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Mise à la terre</h2>
      <div class="row">
        ${b(`Complète (${euro(IS_TERRA.complete_base)})`,"terreComplete()")}
        ${b(`Piquet supp. +2m câblette (${euro(IS_TERRA.piquet_supp)})`,"terrePiquetSupp()")}
        ${b(`Partielle — Rempl. conducteur 16mm² (${euro(IS_TERRA.part_conducteur_m)}/m)`,"terreRemplacementConducteur()")}
        ${b(`Partielle — Barrette coupure (${euro(IS_TERRA.part_barrette)})`,"terreBarrette()")}
        ${b(`Partielle — Piquet pack (${euro(IS_TERRA.part_piquet_pack)})`,"terrePiquetPack()")}
      </div>
    </div>
  `);
}
function terreComplete(){
  addIS("Mise à la terre",
    "Mise à la terre complète (conducteur 16mm² tableau→barrette, barrette, 4 piquets, 10m câblette 25mm²)",
    IS_TERRA.complete_base, 1, "u");
}
function terrePiquetSupp(){
  // quantité de piquets supplémentaires
  const q = parseInt(prompt("Nombre de piquets supplémentaires (+2m de câblette chacun) :", "1")||"0",10);
  if(q>0) addIS("Mise à la terre","Piquet supplémentaire (+2m câblette)", IS_TERRA.piquet_supp, q, "u");
  else pageISTerre();
}
function terreRemplacementConducteur(){
  // mètres de conducteur principal 16mm²
  const m = parseFloat(prompt("Longueur de conducteur principal 16mm² (en mètres) :", "1")||"0");
  if(m>0) addIS("Mise à la terre","Remplacement conducteur principal 16mm²", IS_TERRA.part_conducteur_m, m, "m");
  else pageISTerre();
}
function terreBarrette(){
  addIS("Mise à la terre","Pose d’une barrette de coupure", IS_TERRA.part_barrette, 1, "u");
}
function terrePiquetPack(){
  const q = parseInt(prompt("Nombre de piquets pack (avec câblette) :", "1")||"0",10);
  if(q>0) addIS("Mise à la terre","Piquet supplémentaire (pack avec câblette)", IS_TERRA.part_piquet_pack, q, "u");
  else pageISTerre();
}

/* ===== VENTILATION ===== */
function pageISVentil(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Ventilation</h2>
      <div class="row">
        ${b(`Remplacement bouche (${euro(IS_VENTIL.bouche_remplacement)})`,"ventilBoucheRempl()")}
        ${b(`Création bouche (${euro(IS_VENTIL.bouche_creation)})`,"ventilBoucheCreation()")}
        ${b(`Remplacement groupe VMC (${euro(IS_VENTIL.groupe_remplacement)})`,"ventilGroupeRempl()")}
        ${b(`Pack création VMC (${euro(IS_VENTIL.pack_creation)})`,"ventilPackCreation()")}
        ${b(`Bouche supplémentaire (${euro(IS_VENTIL.bouche_supp)})`,"ventilBoucheSupp()")}
        ${b(`Gaine supplémentaire (${euro(IS_VENTIL.gaine_m)}/m)`,"ventilGaineM()")}
        ${b(`Chapeau toiture Ø125 (${euro(IS_VENTIL.chapeau_125)})`,"ventilChapeau()")}
        ${b(`Alimentation groupe (${euro(IS_VENTIL.alim_groupe)})`,"ventilAlim()")}
        ${b(`Nettoyage / réglage (${euro(IS_VENTIL.nettoyage)})`,"ventilNettoyage()")}
      </div>
    </div>
  `);
}
function ventilBoucheRempl(){
  const q = parseInt(prompt("Nombre de bouches à remplacer :", "1")||"0",10);
  if(q>0) addIS("Ventilation","Remplacement bouche d’extraction", IS_VENTIL.bouche_remplacement, q, "u");
  else pageISVentil();
}
function ventilBoucheCreation(){
  const q = parseInt(prompt("Nombre de bouches à créer :", "1")||"0",10);
  if(q>0) addIS("Ventilation","Création bouche d’extraction", IS_VENTIL.bouche_creation, q, "u");
  else pageISVentil();
}
function ventilGroupeRempl(){
  addIS("Ventilation","Remplacement groupe VMC simple flux", IS_VENTIL.groupe_remplacement, 1, "u");
}
function ventilPackCreation(){
  addIS("Ventilation","Pack création VMC (groupe + 2 bouches + ~10m gaine + sortie murale)", IS_VENTIL.pack_creation, 1, "u");
}
function ventilBoucheSupp(){
  const q = parseInt(prompt("Nombre de bouches supplémentaires :", "1")||"0",10);
  if(q>0) addIS("Ventilation","Bouche supplémentaire", IS_VENTIL.bouche_supp, q, "u");
  else pageISVentil();
}
function ventilGaineM(){
  const m = parseFloat(prompt("Longueur de gaine (m) :", "1")||"0");
  if(m>0) addIS("Ventilation","Gaine supplémentaire Ø125", IS_VENTIL.gaine_m, m, "m");
  else pageISVentil();
}
function ventilChapeau(){
  addIS("Ventilation","Pose chapeau de toiture Ø125", IS_VENTIL.chapeau_125, 1, "u");
}
function ventilAlim(){
  addIS("Ventilation","Alimentation électrique du groupe VMC", IS_VENTIL.alim_groupe, 1, "u");
}
function ventilNettoyage(){
  addIS("Ventilation","Nettoyage / réglage réseau VMC", IS_VENTIL.nettoyage, 1, "u");
}

/* ===== DISTRIBUTION TABLEAU ===== */
function pageISTableau(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Distribution tableau</h2>
      <div class="row">
        ${b(`Création circuit prises (${euro(IS_TABLEAU.circ_prises)})`,"tabCircPrises()")}
        ${b(`Création circuit éclairage (${euro(IS_TABLEAU.circ_eclairage)})`,"tabCircEclairage()")}
        ${b(`Création circuit spécialisé (${euro(IS_TABLEAU.circ_specialise)})`,"tabCircSpecialise()")}
        ${b(`Recâblage circuit (${euro(IS_TABLEAU.recablage_circuit)})`,"tabRecablage()")}
        ${b(`Remplacement protection (${euro(IS_TABLEAU.remplacement_protection)})`,"tabRemplProtection()")}
        ${b(`Remplacement tableau complet (${euro(IS_TABLEAU.remplacement_tableau)})`,"tabRemplTableau()")}
        ${b(`Création tableau secondaire (${euro(IS_TABLEAU.tableau_secondaire)})`,"tabSecondaire()")}
        ${b(`Extension tableau (${euro(IS_TABLEAU.extension_tableau)})`,"tabExtension()")}
      </div>
    </div>
  `);
}
function tabCircPrises(){
  const q = parseInt(prompt("Nombre de circuits prises à créer :", "1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit prises", IS_TABLEAU.circ_prises, q, "u");
  else pageISTableau();
}
function tabCircEclairage(){
  const q = parseInt(prompt("Nombre de circuits éclairage à créer :", "1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit éclairage", IS_TABLEAU.circ_eclairage, q, "u");
  else pageISTableau();
}
function tabCircSpecialise(){
  const q = parseInt(prompt("Nombre de circuits spécialisés à créer :", "1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit spécialisé", IS_TABLEAU.circ_specialise, q, "u");
  else pageISTableau();
}
function tabRecablage(){
  const q = parseInt(prompt("Nombre de circuits à recâbler :", "1")||"0",10);
  if(q>0) addIS("Distribution tableau","Recâblage de circuit", IS_TABLEAU.recablage_circuit, q, "u");
  else pageISTableau();
}
function tabRemplProtection(){
  const q = parseInt(prompt("Nombre de protections à remplacer (DJ / diff.) :", "1")||"0",10);
  if(q>0) addIS("Distribution tableau","Remplacement de protection", IS_TABLEAU.remplacement_protection, q, "u");
  else pageISTableau();
}
function tabRemplTableau(){
  addIS("Distribution tableau","Remplacement tableau complet (même emplacement / nb circuits)", IS_TABLEAU.remplacement_tableau, 1, "u");
}
function tabSecondaire(){
  addIS("Distribution tableau","Création d’un tableau secondaire", IS_TABLEAU.tableau_secondaire, 1, "u");
}
function tabExtension(){
  addIS("Distribution tableau","Extension de tableau (rangées / modules)", IS_TABLEAU.extension_tableau, 1, "u");
}
/* ================================
   PARTIE 4 — ESTIMATIF & TOTAUX
   ================================ */

function pageEstimatif(){
  let html = `<div class="card">
                ${b("Retour","pageHome()","btn back")}
                <h2>Estimatif détaillé</h2>`;
  let totalGlobal = 0;

  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue; // skip vides

    let sectionTotal = 0;
    html += `<h3><strong>${section}</strong></h3><ul>`;
    devis[section].items.forEach(item => {
      const prixTotal = item.prixU * item.qty;
      sectionTotal += prixTotal;
      html += `<li>${item.intervention ? item.intervention + " — " : ""}${item.designation} (${item.qty} ${item.unit} × ${euro(item.prixU)} = ${euro(prixTotal)})</li>`;
    });

    if (devis[section].note) {
      html += `<li><em>Note : ${devis[section].note}</em></li>`;
    }

    html += `</ul><p><strong>Total ${section} : ${euro(sectionTotal)}</strong></p><hr>`;
    totalGlobal += sectionTotal;
  }

  html += `<h3>Total global : ${euro(totalGlobal)}</h3></div>`;
  view(html);
}

/* ================================
   PAGE TOTAUX SEULES (depuis accueil)
   ================================ */
function pageTotaux(){
  let html = `<div class="card">
                ${b("Retour","pageHome()","btn back")}
                <h2>Totaux par section</h2>`;
  let totalGlobal = 0;

  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    const sectionTotal = devis[section].items.reduce((sum, it) => sum + (it.prixU * it.qty), 0);
    totalGlobal += sectionTotal;
    html += `<p><strong>${section}</strong> : ${euro(sectionTotal)}</p>`;
  }

  html += `<hr><p><strong>Total global : ${euro(totalGlobal)}</strong></p></div>`;
  view(html);
}
/* ================================
   PARTIE 5 — PAGE D'ACCUEIL
   ================================ */

const pieces = [
  "Cuisine",
  "Chambre",
  "Salle de bain",
  "Salle d'eau",
  "Garage",
  "Couloir",
  "Débarras",
  "Salon",
  "Salle à manger",
  "Extérieur",
  "Grenier/Combles"
];

const installationsSpecifiques = [
  "Mise à la terre",
  "Ventilation",
  "Distribution tableau"
];

function pageHome(){
  let html = `<div class="card">
                <h2>Choisissez une pièce</h2>
                <div style="display:flex;flex-wrap:wrap;gap:10px;">`;
  
  pieces.forEach(piece => {
    html += `<button style="flex:1 1 calc(50% - 10px);" onclick="selectPiece('${piece}')">${piece}</button>`;
  });

  html += `</div>
           <h2 style="margin-top:20px;">Installations spécifiques</h2>
           <div style="display:flex;flex-wrap:wrap;gap:10px;">`;

  installationsSpecifiques.forEach(inst => {
    html += `<button style="flex:1 1 calc(50% - 10px);" onclick="selectInstallation('${inst}')">${inst}</button>`;
  });

  html += `</div>
           <hr>
           ${b("Voir estimatif détaillé","pageEstimatif()","btn")}
           ${b("Voir totaux","pageTotaux()","btn")}
           </div>`;
  
  view(html);
}
/* ===========================
   PARTIE 6 — COLLE-TOUT & ALIAS
   =========================== */

/* Depuis l'accueil (Partie 5) */
function selectPiece(piece){
  goPiece(piece); // défini en Partie 2
}
function selectInstallation(inst){
  if (inst === "Mise à la terre") return pageISTerre();     // Partie 3
  if (inst === "Ventilation") return pageISVentil();         // Partie 3
  if (inst === "Distribution tableau") return pageISTableau();// Partie 3
}

/* Harmonisation des noms (selon où tu cliques) */
function pageResume(){ pageEstimatif(); } // alias -> Partie 4
function pageTotals(){ pageTotaux(); }    // alias -> Partie 4
