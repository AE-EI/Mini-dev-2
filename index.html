<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de Devis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .page {
            display: none;
            padding: 20px;
        }
        .active {
            display: block;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .back-btn {
            background-color: #ccc;
            margin-bottom: 10px;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
        }
        .note {
            font-style: italic;
        }
        .total {
            font-weight: bold;
        }
        #version-banner {
            background-color: #007BFF;
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="version-banner">Version stable</div>
<header>
    <h1>Créateur de Devis</h1>
</header>

<!-- PAGE 1 : Code d'accès -->
<div id="page-code" class="page active">
    <h2>Veuillez entrer le code d'accès</h2>
    <input type="password" id="access-code" placeholder="Code" />
    <button onclick="checkCode()">Valider</button>
    <p id="code-error" style="color:red; display:none;">Code incorrect</p>
</div>

<!-- PAGE 2 : Menu principal -->
<div id="page-menu" class="page">
    <h2>Menu Principal</h2>
    <div class="button-grid" id="main-menu">
        <!-- Boutons générés dynamiquement -->
    </div>
</div>

<!-- PAGE 3 : Sélection catégorie -->
<div id="page-category" class="page">
    <button class="back-btn" onclick="showPage('page-menu')">Retour</button>
    <h2 id="piece-title"></h2>
    <div class="button-grid" id="category-list">
        <!-- Catégories -->
    </div>
</div>

<!-- PAGE 4 : Sélection intervention -->
<div id="page-intervention" class="page">
    <button class="back-btn" onclick="showPage('page-category')">Retour</button>
    <h2 id="category-title"></h2>
    <div class="button-grid" id="intervention-list">
        <!-- Interventions -->
    </div>
</div>

<!-- PAGE 5 : Sélection type de pose -->
<div id="page-pose" class="page">
    <button class="back-btn" onclick="showPage('page-intervention')">Retour</button>
    <h2>Type de pose</h2>
    <div class="button-grid" id="pose-list"></div>
</div>

<!-- PAGE 6 : Quantité -->
<div id="page-quantity" class="page">
    <button class="back-btn" onclick="showPage('page-pose')">Retour</button>
    <h2>Quantité</h2>
    <div class="button-grid" id="quantity-buttons"></div>
</div>

<!-- PAGE 7 : Note -->
<div id="page-note" class="page">
    <button class="back-btn" onclick="showPage('page-quantity')">Retour</button>
    <h2>Ajouter une note ?</h2>
    <textarea id="note-text" placeholder="Note (facultatif)"></textarea>
    <button onclick="saveItem()">Valider</button>
</div>

<!-- PAGE 8 : Totaux -->
<div id="page-totals" class="page">
    <button class="back-btn" onclick="showPage('page-menu')">Retour</button>
    <h2>Récapitulatif</h2>
    <pre id="totals-output"></pre>
    <button class="export-btn" onclick="exportText()">Exporter en texte</button>
</div>

<script>
  // ======== VARIABLES ========

// Code d'accès
const ACCESS_CODE = "2846"; // Code défini

// Données globales
let devis = {};
let currentPiece = "";
let currentCategory = "";
let currentIntervention = "";
let currentPose = "";
let currentQuantity = 0;
let currentNote = "";

// Menu principal avec installations spécifiques
const mainMenuButtons = [
    { text: "Ajouter une pièce", action: () => goToAddPiece() },
    { text: "Ajouter installation spécifique", action: () => goToSpecificInstallations() },
    { text: "Voir les totaux", action: () => goToTotals() }
];

// Liste des pièces prédéfinies
const predefinedPieces = [
    "Cuisine", "Chambre", "Salle de bain", "Salle d'eau",
    "Garage", "Couloir", "Débarras", "Salon", "Salle à manger",
    "Extérieur", "Grenier/Combles", "Créer une nouvelle pièce"
];

// Catégories classiques
const categories = ["Prises", "Éclairage"];

// Interventions possibles
const interventions = {
    "Prises": ["Création", "Recâblage avec remplacement appareillage", "Recâblage sans remplacement appareillage"],
    "Éclairage": ["Création", "Recâblage avec remplacement luminaire", "Recâblage sans remplacement luminaire"]
};

// Types de pose
const poses = ["Encastre maçonnerie", "Placo", "Semi encastré", "Sur-mesure"];

// Prix par défaut
const prices = {
    "Prises": {
        "Création": 120,
        "Recâblage avec remplacement appareillage": 70,
        "Recâblage sans remplacement appareillage": 50
    },
    "Éclairage": {
        "Création": 100,
        "Recâblage avec remplacement luminaire": 75,
        "Recâblage sans remplacement luminaire": 50
    }
};

// Installations spécifiques (exemple)
const specificInstallations = [
    { name: "Ventilation", price: 300 },
    { name: "Mise à la terre complète", price: 500 },
    { name: "Tableau électrique complet", price: 1500 }
];

// ======== FONCTIONS ========

// Affiche une page
function showPage(pageId) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(pageId).classList.add("active");
}

// Vérifie le code d'accès
function checkCode() {
    const entered = document.getElementById("access-code").value;
    if (entered === ACCESS_CODE) {
        buildMainMenu();
        showPage("page-menu");
        document.getElementById("code-error").style.display = "none";
    } else {
        document.getElementById("code-error").style.display = "block";
    }
}

// Construit le menu principal
function buildMainMenu() {
    const container = document.getElementById("main-menu");
    container.innerHTML = "";
    mainMenuButtons.forEach(btnData => {
        const btn = document.createElement("button");
        btn.textContent = btnData.text;
        btn.onclick = btnData.action;
        container.appendChild(btn);
    });
}

// Aller à l'ajout de pièce
function goToAddPiece() {
    const list = document.getElementById("category-list");
    list.innerHTML = "";
    predefinedPieces.forEach(piece => {
        const btn = document.createElement("button");
        btn.textContent = piece;
        btn.onclick = () => {
            currentPiece = piece;
            goToCategory();
        };
        list.appendChild(btn);
    });
    document.getElementById("piece-title").textContent = "Ajouter une pièce";
    showPage("page-category");
}

// Aller aux installations spécifiques
function goToSpecificInstallations() {
    const list = document.getElementById("intervention-list");
    list.innerHTML = "";
    specificInstallations.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = `${item.name} - ${item.price}€`;
        btn.onclick = () => {
            currentPiece = "Installation spécifique";
            currentCategory = "Spécifique";
            currentIntervention = item.name;
            currentPose = "";
            currentQuantity = 1;
            currentNote = "";
            saveItem(item.price);
        };
        list.appendChild(btn);
    });
    document.getElementById("category-title").textContent = "Installations spécifiques";
    showPage("page-intervention");
}

// Aller à la sélection de catégorie
function goToCategory() {
    const list = document.getElementById("category-list");
    list.innerHTML = "";
    categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => selectCategory(cat);
        list.appendChild(btn);
    });
    showPage("page-category");
}

// Sélection d'une catégorie
function selectCategory(cat) {
    currentCategory = cat;
    const list = document.getElementById("intervention-list");
    list.innerHTML = "";
    interventions[cat].forEach(inter => {
        const btn = document.createElement("button");
        btn.textContent = inter;
        btn.onclick = () => selectIntervention(inter);
        list.appendChild(btn);
    });
    document.getElementById("category-title").textContent = `${cat} - ${currentPiece}`;
    showPage("page-intervention");
}

// Sélection intervention
function selectIntervention(inter) {
    currentIntervention = inter;
    goToPose();
}

// Sélection type de pose
function goToPose() {
    const list = document.getElementById("pose-list");
    list.innerHTML = "";
    poses.forEach(pose => {
        const btn = document.createElement("button");
        btn.textContent = pose;
        btn.onclick = () => selectPose(pose);
        list.appendChild(btn);
    });
    showPage("page-pose");
}

function selectPose(pose) {
    currentPose = pose;
    goToQuantity();
}

// Sélection quantité
function goToQuantity() {
    const list = document.getElementById("quantity-buttons");
    list.innerHTML = "";
    for (let i = 1; i <= 20; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.onclick = () => {
            currentQuantity = i;
            goToNote();
        };
        list.appendChild(btn);
    }
    showPage("page-quantity");
}

// Page note
function goToNote() {
    document.getElementById("note-text").value = "";
    showPage("page-note");
}

// Sauvegarde
function saveItem(customPrice = null) {
    currentNote = document.getElementById("note-text").value.trim();
    if (!devis[currentPiece]) devis[currentPiece] = [];

    let price = customPrice !== null
        ? customPrice
        : prices[currentCategory]?.[currentIntervention] || 0;

    devis[currentPiece].push({
        category: currentCategory,
        intervention: currentIntervention,
        pose: currentPose,
        quantity: currentQuantity,
        note: currentNote,
        price: price
    });

    showPage("page-menu");
}

// Totaux
function goToTotals() {
    const output = document.getElementById("totals-output");
    let totalGlobal = 0;
    let text = "";

    for (const piece in devis) {
        if (devis[piece].length === 0) continue;
        let totalPiece = 0;
        text += `\n**${piece}**\n`;
        devis[piece].forEach(item => {
            const linePrice = item.price * item.quantity;
            totalPiece += linePrice;
            totalGlobal += linePrice;
            text += `- ${item.intervention} ${item.pose ? "(" + item.pose + ")" : ""} x${item.quantity} : ${linePrice}€\n`;
            if (item.note) text += `  _${item.note}_\n`;
        });
        text += `Total ${piece} : ${totalPiece}€\n`;
    }
    text += `\nTotal global : ${totalGlobal}€\n`;
    output.textContent = text;
    showPage("page-totals");
}

// Export texte
function exportText() {
    const text = document.getElementById("totals-output").textContent;
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "devis.txt";
    a.click();
    URL.revokeObjectURL(url);
}

// ======== KILL SERVICE WORKER ========
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for (let registration of registrations) {
            registration.unregister();
        }
        console.log("Tous les service workers ont été supprimés.");
    });
}

</script>
</body>
</html>
